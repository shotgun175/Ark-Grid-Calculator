<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Ark Grid Calculator — Expanded Edition</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Lato:wght@400;700&display=swap" rel="stylesheet">

<style>
  :root {
    --bg-dark: #0f1115;
    --bg-panel: rgba(26, 30, 36, 0.95);
    --bg-input: #08090b;
    --la-gold: #c2a076;
    --la-gold-dim: #7d6b49;
    --la-silver: #aebcd1;
    --la-blue: #3d5e75;
    --la-red: #5e3d3d;
    --la-highlight: #ffebb8;
    --text-main: #e1e6eb;
    --text-muted: #8a96a3;
    --text-gold: #e6cc9c;
    --gap: 20px;
  }

  body {
    font-family: 'Lato', sans-serif;
    margin: 0;
    padding: 24px;
    background-color: var(--bg-dark);
    background-image: radial-gradient(circle at 50% 0%, #252a33 0%, #0f1115 80%);
    color: var(--text-main);
    min-height: 100vh;
  }

  h1, h2, h3, .section-title, .res-title {
    font-family: 'Cinzel', serif;
    color: var(--text-gold);
    text-shadow: 0 2px 4px rgba(0,0,0,0.8);
    letter-spacing: 0.5px;
  }
  
  h1 {
    font-size: 28px;
    text-align: center;
    border-bottom: 1px solid var(--la-gold-dim);
    padding-bottom: 16px;
    margin-bottom: 24px;
    background: linear-gradient(to right, transparent, rgba(194, 160, 118, 0.1), transparent);
  }

  p.note {
    text-align: center;
    color: var(--text-muted);
    font-size: 14px;
    font-style: italic;
    margin-bottom: 24px;
  }

  .page {
    display: flex;
    gap: var(--gap);
    align-items: flex-start;
    justify-content: center;
    flex-wrap: wrap;
  }

  .half {
    flex: 1;
    min-width: 340px;
    max-width: 600px;
    padding: 20px;
    border: 1px solid #333;
    background: var(--bg-panel);
    box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 0 1px rgba(255,255,255,0.05);
    position: relative;
    display: flex;
    flex-direction: column;
  }
  
  .half::before {
    content: "";
    position: absolute;
    top: 0; left: 0; right: 0; height: 2px;
    background: linear-gradient(90deg, transparent, var(--la-gold-dim), transparent);
  }

  .left { border-top: 3px solid #8a4b4b; }
  .right { border-top: 3px solid #4b6b8a; }

  .section-title {
    font-weight: 700;
    margin: 0 0 16px 0;
    font-size: 18px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .section-title::after { content:""; flex:1; height:1px; background: rgba(255,255,255,0.1); }

  table { width: 100%; border-collapse: separate; border-spacing: 0 4px; margin-bottom: 16px; }
  th { text-align: center; font-family: 'Cinzel', serif; color: var(--text-muted); font-size: 12px; text-transform: uppercase; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
  td { padding: 4px; text-align: center; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.03); }
  tr:hover td { background: rgba(255,255,255,0.05); }

  input[type=number], select {
    background: var(--bg-input);
    border: 1px solid #333;
    color: var(--la-gold);
    padding: 6px;
    font-family: 'Lato', sans-serif;
    text-align: center;
    width: 60px;
    transition: all 0.2s;
  }
  select { width: auto; min-width: 120px; text-align: left; }
  input[type=number]:focus, select:focus { outline: none; border-color: var(--la-gold); box-shadow: 0 0 8px rgba(194, 160, 118, 0.2); }

  /* focused numeric input highlight */
  input[type=number]:focus {
    background: #1a1d23;
    border-color: var(--la-gold);
    box-shadow: 0 0 8px rgba(194,160,118,0.4);
    color: #fff;
  }
  
  label { font-size: 14px; color: var(--text-muted); cursor: pointer; }
  
  .core-config {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 40px;
    background: rgba(0,0,0,0.3);
    padding: 8px 12px;
    border: 1px solid rgba(255,255,255,0.05);
    margin-bottom: 8px;
  }

  button {
    font-family: 'Cinzel', serif; padding: 10px 16px;
    border: 1px solid var(--la-gold-dim);
    background: linear-gradient(180deg, #2b2620 0%, #1a1712 100%);
    color: var(--text-gold); cursor: pointer;
    font-weight: 700; text-transform: uppercase; font-size: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: all 0.2s; min-width: 120px;
  }
  button:hover {
    background: linear-gradient(180deg, #3d362e 0%, #26221c 100%);
    border-color: var(--la-gold); color: var(--la-highlight);
    text-shadow: 0 0 5px var(--la-gold);
  }

  .panel-btn-row { margin-top: auto; padding-top: 16px; display: flex; justify-content: center; }
  .panel-btn-row button { width: 100%; font-size: 14px; letter-spacing: 1px; }

  .common-controls {
    display: flex; 
    justify-content: center; 
    align-items: center;
    gap: 16px;
    margin-top: 24px; 
    margin-bottom: 12px; 
    padding: 16px;
    background: rgba(0,0,0,0.4);
    border-top: 1px solid rgba(255,255,255,0.05);
    border-bottom: 1px solid rgba(255,255,255,0.05);
    flex-wrap: wrap;
  }

  button.secondary {
    background: linear-gradient(180deg, #2a2e33 0%, #181a1d 100%);
    border-color: #4a525c; color: var(--la-silver);
  }
  button.secondary:hover { border-color: var(--text-main); color: #fff; }

  button.primary-gold {
    background: linear-gradient(180deg, #5e3d3d 0%, #3a1f1f 100%); 
    border-color: #8a4b4b; color: var(--la-highlight);
    box-shadow: 0 0 10px rgba(138, 75, 75, 0.4);
  }
  button.primary-gold:hover {
    background: linear-gradient(180deg, #7a4f4f 0%, #4f2a2a 100%);
    box-shadow: 0 0 15px rgba(138, 75, 75, 0.6);
  }

  .small { font-size: 12px; color: var(--text-muted); margin-top: 8px; display: block; }

  #resultsArea { margin-top: 20px; display: flex; gap: var(--gap); justify-content: center; flex-wrap: wrap; }
  .results-half { flex: 1; min-width: 340px; max-width: 600px; background: var(--bg-panel); border: 1px solid #333; padding: 20px; position: relative; }
  
  .core-box {
    margin-bottom: 16px; padding: 12px;
    border: 1px solid #2a2e33;
    background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.2));
    position: relative; box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
  }
  .core-box::before {
    content:""; position:absolute; left:-4px; top:10px; bottom:10px; width:2px;
    background: var(--la-gold-dim); opacity:0.5;
  }
  .core-header {
    display: flex; justify-content: space-between; align-items: flex-end;
    margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 6px;
  }
  .core-header strong { color: var(--la-highlight); font-family: 'Cinzel', serif; }
  .gem-row {
    display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;
    background: rgba(0,0,0,0.3); padding: 10px;
    border-radius: 4px; border: 1px solid rgba(0,0,0,0.5);
  }

  .gem-card {
    display: flex; flex-direction: column; gap: 4px; align-items: center; justify-content: center;
    width: 80px; height: 70px; padding: 4px;
    border: 1px solid rgba(255,255,255,0.1); color: #fff;
    font-weight: 700; font-size: 14px; position: relative;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.8), 0 2px 4px rgba(0,0,0,0.4);
    text-shadow: 0 1px 2px #000;
  }
  
  /* Gem Colors */
  .gem-A { background: radial-gradient(circle at 30% 30%, #ff5252, #8a2b2b); border-color: #ff8a8a; }
  .gem-B { background: radial-gradient(circle at 30% 30%, #ff8c42, #8f4b16); border-color: #ffb580; }
  .gem-C { background: radial-gradient(circle at 30% 30%, #ffd54f, #94720d); border-color: #ffe082; }
  .gem-D { background: radial-gradient(circle at 30% 30%, #9ccc65, #4a6624); border-color: #c5e1a5; }
  .gem-E { background: radial-gradient(circle at 30% 30%, #4caf50, #1b5e20); border-color: #81c784; }
  .gem-F { background: radial-gradient(circle at 30% 30%, #26a69a, #004d40); border-color: #80cbc4; }
  .gem-G { background: radial-gradient(circle at 30% 30%, #29b6f6, #01579b); border-color: #81d4fa; }
  .gem-H { background: radial-gradient(circle at 30% 30%, #3f51b5, #1a237e); border-color: #7986cb; }
  .gem-K { background: radial-gradient(circle at 30% 30%, #9c27b0, #4a148c); border-color: #ce93d8; }
  .gem-L { background: radial-gradient(circle at 30% 30%, #78909c, #37474f); border-color: #b0bec5; }

  .gem-type { font-size: 18px; font-family: 'Cinzel', serif; }
  .gem-sub { font-size: 10px; font-weight: 400; opacity: 0.9; text-transform: uppercase; letter-spacing: 0.5px; }
  .badge { background: #000; color: var(--text-muted); padding: 4px 8px; border: 1px solid #333; font-size: 11px; display: inline-block; }
  .remaining-badges { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 8px; }

  /* Core rarity accents */
  .core-header[data-rarity="Legendary"] strong { color: var(--text-main); }
  .core-header[data-rarity="Relic"]     strong { color: var(--text-main); }
  .core-header[data-rarity="Ancient"]   strong { color: var(--text-main); }

  .core-box[data-rarity="Legendary"] {
    background: linear-gradient(180deg, rgba(255,140,66,0.15), rgba(0,0,0,0.3));
    border-color: #ff8c4288;
    box-shadow: 0 0 16px rgba(255,140,66,0.25) inset;
  }
  .core-box[data-rarity="Relic"] {
    background: linear-gradient(180deg, rgba(255,82,82,0.15), rgba(0,0,0,0.3));
    border-color: #ff525288;
    box-shadow: 0 0 16px rgba(255,82,82,0.25) inset;
  }
  .core-box[data-rarity="Ancient"] {
    background: linear-gradient(180deg, rgba(230,204,156,0.15), rgba(0,0,0,0.3));
    border-color: var(--text-gold);
    box-shadow: 0 0 16px rgba(230,204,156,0.25) inset;
  }

  /* Rarity dropdown styling */
  .core-rarity-select {
    min-width: 150px;
    padding: 4px 8px;
    background: #15171b;
  }
  .core-rarity-select[data-rarity="Legendary"] {
    border-color: #ff8c42;
    color: #ff8c42;
    box-shadow: 0 0 8px rgba(255,140,66,0.2);
  }
  .core-rarity-select[data-rarity="Relic"] {
    border-color: #ff5252;
    color: #ff5252;
    box-shadow: 0 0 8px rgba(255,82,82,0.2);
  }
  .core-rarity-select[data-rarity="Ancient"] {
    border-color: var(--text-gold);
    color: var(--text-gold);
    box-shadow: 0 0 8px rgba(230,204,156,0.2);
  }

  @media (max-width: 900px) {
    .page, #resultsArea { 
      flex-direction: column; 
      align-items: stretch; 
    }
    .half, .results-half { 
      max-width: none; 
    }
  }
</style>
</head>
<body>

<h1>Ark Grid Calculator</h1>
<p class="note">Manage your nodes. Optimize your Ark Passive.</p>

<div class="page">
  <div class="half left">
    <h2 class="section-title">Class Inventory</h2>
    <table aria-label="Class inventory">
      <thead><tr><th>Gem</th><th>Will</th><th>Pts</th><th>Qty</th></tr></thead>
      <tbody>
        <tr><td><span style="color:#ff5252">A</span></td><td>3</td><td>5</td><td><input id="class_A" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#ff8c42">B</span></td><td>3</td><td>4</td><td><input id="class_B" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#ffd54f">C</span></td><td>3</td><td>3</td><td><input id="class_C" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#9ccc65">D</span></td><td>4</td><td>5</td><td><input id="class_D" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#4caf50">E</span></td><td>4</td><td>4</td><td><input id="class_E" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#26a69a">F</span></td><td>4</td><td>3</td><td><input id="class_F" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#29b6f6">G</span></td><td>5</td><td>5</td><td><input id="class_G" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#3f51b5">H</span></td><td>5</td><td>4</td><td><input id="class_H" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#9c27b0">K</span></td><td>5</td><td>3</td><td><input id="class_K" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#78909c">L</span></td><td>6</td><td>5</td><td><input id="class_L" type="number" min="0" value="0"></td></tr>
      </tbody>
    </table>

    <div style="margin-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:8px;">
      <label><input id="classAuto" type="checkbox" checked> Auto Target (20pts priority)</label>
    </div>

    <div id="class_core_config"></div>

    <div class="panel-btn-row">
      <button onclick="calculateClass()">Calculate</button>
    </div>
  </div>

  <div class="half right">
    <h2 class="section-title">General Inventory</h2>
    <table aria-label="General inventory">
      <thead><tr><th>Gem</th><th>Will</th><th>Pts</th><th>Qty</th></tr></thead>
      <tbody>
        <tr><td><span style="color:#ff5252">A</span></td><td>3</td><td>5</td><td><input id="general_A" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#ff8c42">B</span></td><td>3</td><td>4</td><td><input id="general_B" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#ffd54f">C</span></td><td>3</td><td>3</td><td><input id="general_C" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#9ccc65">D</span></td><td>4</td><td>5</td><td><input id="general_D" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#4caf50">E</span></td><td>4</td><td>4</td><td><input id="general_E" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#26a69a">F</span></td><td>4</td><td>3</td><td><input id="general_F" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#29b6f6">G</span></td><td>5</td><td>5</td><td><input id="general_G" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#3f51b5">H</span></td><td>5</td><td>4</td><td><input id="general_H" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#9c27b0">K</span></td><td>5</td><td>3</td><td><input id="general_K" type="number" min="0" value="0"></td></tr>
        <tr><td><span style="color:#78909c">L</span></td><td>6</td><td>5</td><td><input id="general_L" type="number" min="0" value="0"></td></tr>
      </tbody>
    </table>

    <div style="margin-bottom:12px; border-bottom:1px solid rgba(255,255,255,0.05); padding-bottom:8px;">
      <label><input id="generalAuto" type="checkbox" checked> Auto Target (20pts priority)</label>
    </div>

    <div id="general_core_config"></div>

    <div class="panel-btn-row">
      <button onclick="calculateGeneral()">Calculate</button>
    </div>
  </div>
</div>

<div class="common-controls">
  <div style="display:flex; align-items:center; gap:8px; flex-wrap:wrap;">
    <label for="inventorySelect" style="font-size:13px; color:var(--text-muted);">Preset:</label>
    <select id="inventorySelect">
      <option value="">(no preset selected)</option>
    </select>
  </div>
  <button class="secondary" onclick="saveInventory()">Save Preset</button>
  <button class="secondary" onclick="loadInventory()">Load Preset</button>
  <button class="secondary" onclick="deleteInventory()">Delete Preset</button>
  <div style="width:20px;"></div>
  <button class="secondary" onclick="resetDefaults()">Reset Data</button>
  <button class="primary-gold" onclick="calculateBoth()">Calculate Both</button>
</div>

<div id="resultsArea">
  <div class="results-half" id="classResults">
    <h3 class="res-title">Class Optimization</h3>
    <div id="classResultsInner" class="small">Pending calculation...</div>
  </div>

  <div class="results-half" id="generalResults">
    <h3 class="res-title">General Optimization</h3>
    <div id="generalResultsInner" class="small">Pending calculation...</div>
  </div>
</div>

<script>
/* -------------------------
   Constants & Logic
   ------------------------- */
const ASTROGEMS = {
  A: { will: 3, points: 5 },
  B: { will: 3, points: 4 },
  C: { will: 3, points: 3 },
  D: { will: 4, points: 5 },
  E: { will: 4, points: 4 },
  F: { will: 4, points: 3 },
  G: { will: 5, points: 5 },
  H: { will: 5, points: 4 },
  K: { will: 5, points: 3 },
  L: { will: 6, points: 5 }
};

const CORE_WILL = { 
  Legendary: 12,
  Relic: 15, 
  Ancient: 17 
};

const MAX_SLOTS = 4;
const MAX_CORES = 3;

// Weighted preference (Higher = better efficiency/utility)
const GEM_WEIGHT = { 
  A: 10, B: 9, C: 8, 
  D: 7, E: 6, F: 5, 
  G: 4, H: 3, K: 2, 
  L: 1 
};
const TOP_N = 300; 

// Multi-inventory storage keys
const STORAGE_KEY_MULTI = 'arkGridInventory_v7_multi';
const STORAGE_KEY_LAST  = 'arkGridInventory_v7_lastPreset';

/* -------------------------
   Inventory storage helpers
   ------------------------- */
function getAllInventories() {
  const raw = localStorage.getItem(STORAGE_KEY_MULTI);
  if (!raw) return {};
  try {
    const obj = JSON.parse(raw);
    return obj && typeof obj === 'object' ? obj : {};
  } catch (e) {
    return {};
  }
}

function saveAllInventories(map) {
  localStorage.setItem(STORAGE_KEY_MULTI, JSON.stringify(map));
}

function refreshPresetDropdown(selectedName) {
  const select = document.getElementById('inventorySelect');
  if (!select) return;
  const all = getAllInventories();
  const names = Object.keys(all).sort();
  const current = selectedName || select.value;

  let options = '<option value="">(no preset selected)</option>';
  for (const n of names) {
    options += `<option value="${n}">${n}</option>`;
  }
  select.innerHTML = options;

  if (current && names.includes(current)) {
    select.value = current;
  } else {
    select.value = '';
  }
}

/* -------------------------
   Rarity dropdown styling
   ------------------------- */
function updateCoreSelectStyle(selectEl){
  if(!selectEl) return;
  const val = selectEl.value;
  selectEl.setAttribute('data-rarity', val);
}

/* -------------------------
   Core config UI builders
   ------------------------- */
function buildCoreConfig(containerId, prefix){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  for(let i=1;i<=3;i++){
    const coreId    = `${prefix}_core${i}_rarity`;
    const enabledId = `${prefix}_core${i}_enabled`;
    const div = document.createElement('div');
    div.className = 'core-config';
    div.id = `${prefix}_corecfg_${i}`;
    div.innerHTML = `
      <label title="Enable or disable Core ${i} in optimization"
             style="display:flex;align-items:center;gap:6px;">
        <input type="checkbox" id="${enabledId}" checked>
        Core ${i}:
        <select id="${coreId}" class="core-rarity-select" data-rarity="Legendary">
          <option value="Legendary" style="color:#ff8c42;">Legendary (12 WP)</option>
          <option value="Relic" style="color:#ff5252;">Relic (15 WP)</option>
          <option value="Ancient" style="color:var(--text-gold);">Ancient (17 WP)</option>
        </select>
      </label>
      <label class="target-wrap" id="${prefix}_core${i}_target_wrap">Target:
        <select id="${prefix}_core${i}_target">
          ${Array.from({length:11}, (_,k)=>10+k).map(v=>`<option value="${v}">${v}</option>`).join('')}
        </select>
      </label>
    `;
    container.appendChild(div);

    const sel = document.getElementById(coreId);
    if (sel) {
      sel.addEventListener('change', () => updateCoreSelectStyle(sel));
      updateCoreSelectStyle(sel);
    }
  }

  const autoCheckbox = document.getElementById(prefix === 'class' ? 'classAuto' : 'generalAuto');
  function updateVisibility(){
    const hide = autoCheckbox.checked;
    for(let i=1;i<=3;i++){
      const wrap = document.getElementById(`${prefix}_core${i}_target_wrap`);
      if(hide) wrap.style.display = 'none'; else wrap.style.display = 'inline-block';
    }
  }
  autoCheckbox.addEventListener('change', updateVisibility);
  updateVisibility();
}

/* -------------------------
   Inventory helpers
   ------------------------- */
function readInventory(prefix){
  const inv = {};
  for(const t of Object.keys(ASTROGEMS)){
    const el = document.getElementById(`${prefix}_${t}`);
    inv[t] = Math.max(0, parseInt(el.value || '0'));
  }
  return inv;
}

/* resets both result panels after inventory changes */
function resetResultsPanels() {
  document.getElementById('classResultsInner').innerHTML =
    '<div class="small">Pending calculation...</div>';
  document.getElementById('generalResultsInner').innerHTML =
    '<div class="small">Pending calculation...</div>';
}

/* saves inventory + core types + enabled flags into preset storage */
function saveInventory(){
  const select = document.getElementById('inventorySelect');
  const defaultName = (select && select.value) ? select.value : '';

  const name = prompt(
    'Enter a name for this inventory preset (e.g. "Raid", "PvP", "Alt 1"):',
    defaultName
  );
  if (!name) return;
  const trimmed = name.trim();
  if (!trimmed) return;

  const classInv   = readInventory('class');
  const generalInv = readInventory('general');

  const classCoreCfg   = readCoreConfigs('class');
  const generalCoreCfg = readCoreConfigs('general');

  const classCores        = classCoreCfg.map(c => c.rarity);
  const generalCores      = generalCoreCfg.map(c => c.rarity);
  const classCoreEnabled  = classCoreCfg.map(c => !!c.enabled);
  const generalCoreEnabled= generalCoreCfg.map(c => !!c.enabled);

  const all = getAllInventories();

  all[trimmed] = {
    class: classInv,
    general: generalInv,
    classCores,
    generalCores,
    classCoreEnabled,
    generalCoreEnabled
  };

  saveAllInventories(all);
  localStorage.setItem(STORAGE_KEY_LAST, trimmed);

  refreshPresetDropdown(trimmed);
  alert(`Inventory saved as "${trimmed}".`);
}

/* loads inventory + core types + enabled flags from preset storage */
function loadPresetByName(name, { silent = false } = {}) {
  if (!name) return false;

  const all = getAllInventories();
  const obj = all[name];
  if (!obj) return false;

  // load inventory
  for (const t of Object.keys(ASTROGEMS)) {
    if (obj.class   && obj.class[t]   !== undefined) document.getElementById(`class_${t}`).value   = obj.class[t];
    if (obj.general && obj.general[t] !== undefined) document.getElementById(`general_${t}`).value = obj.general[t];
  }

  resetResultsPanels();

  // restore core rarity + enabled for class
  if (obj.classCores) {
    obj.classCores.forEach((rarity, i) => {
      const sel = document.getElementById(`class_core${i+1}_rarity`);
      if (sel) {
        sel.value = rarity;
        updateCoreSelectStyle(sel);
      }
    });
  }
  if (obj.classCoreEnabled) {
    obj.classCoreEnabled.forEach((enabled, i) => {
      const cb = document.getElementById(`class_core${i+1}_enabled`);
      if (cb) cb.checked = !!enabled;
    });
  }

  // restore core rarity + enabled for general
  if (obj.generalCores) {
    obj.generalCores.forEach((rarity, i) => {
      const sel = document.getElementById(`general_core${i+1}_rarity`);
      if (sel) {
        sel.value = rarity;
        updateCoreSelectStyle(sel);
      }
    });
  }
  if (obj.generalCoreEnabled) {
    obj.generalCoreEnabled.forEach((enabled, i) => {
      const cb = document.getElementById(`general_core${i+1}_enabled`);
      if (cb) cb.checked = !!enabled;
    });
  }

  localStorage.setItem(STORAGE_KEY_LAST, name);

  if (!silent) alert(`Inventory "${name}" loaded.`);
  return true;
}

/* UI handler for loading selected preset */
function loadInventory(){
  const select = document.getElementById('inventorySelect');
  const name = select ? select.value : '';

  if (!name) {
    alert('Select a preset from the dropdown first.');
    return;
  }

  const ok = loadPresetByName(name, { silent: false });

  if (!ok) {
    alert('Preset not found.');
    refreshPresetDropdown();
  }
}

function deleteInventory() {
  const select = document.getElementById('inventorySelect');
  const name = select ? select.value : '';
  if (!name) {
    alert('Select a preset to delete.');
    return;
  }

  if (!confirm(`Delete preset "${name}"? This cannot be undone.`)) return;

  const all = getAllInventories();
  if (all[name]) {
    delete all[name];
    saveAllInventories(all);

    const last = localStorage.getItem(STORAGE_KEY_LAST);
    if (last === name) {
      localStorage.removeItem(STORAGE_KEY_LAST);
    }

    refreshPresetDropdown();
    alert(`Preset "${name}" deleted.`);
  } else {
    alert('Preset not found.');
    refreshPresetDropdown();
  }
}

function resetDefaults(){
  const sides = ['class', 'general'];
  const gems = Object.keys(ASTROGEMS);
  sides.forEach(side => {
    gems.forEach(gem => {
      const el = document.getElementById(`${side}_${gem}`);
      if(el) el.value = 0;
    });
    // reset core enabled to true
    for (let i = 1; i <= 3; i++) {
      const cb = document.getElementById(`${side}_core${i}_enabled`);
      if (cb) cb.checked = true;
    }
  });
  resetResultsPanels();
}

/* -------------------------
   Core combination generator
   ------------------------- */
function generateCoreCombos(inv, maxWill) {
  const types = Object.keys(ASTROGEMS);
  const results = [];
  
  function backtrack(start, combo, counts){
    if(combo.length>0){
      let will=0, points=0;
      for(const t of combo){ will+=ASTROGEMS[t].will; points+=ASTROGEMS[t].points; }
      if(will<=maxWill){
        let pref=0; for(const t of combo) pref += (GEM_WEIGHT[t]||0);
        results.push({ combo: combo.slice(), counts: {...counts}, will, points, prefScore: pref });
      }
    }
    if(combo.length===MAX_SLOTS) return;
    for(let i=start;i<types.length;i++){
      const t = types[i];
      const used = counts[t]||0;
      if(used < (inv[t]||0)){
        combo.push(t);
        counts[t] = used+1;
        backtrack(i, combo, counts);
        combo.pop();
        if(used===0) delete counts[t]; else counts[t]=used;
      }
    }
  }
  backtrack(0, [], {});

  const byPoints = {};
  for(const r of results) {
    if(!byPoints[r.points]) byPoints[r.points] = [];
    byPoints[r.points].push(r);
  }

  const finalResults = [];
  Object.keys(byPoints).sort((a,b)=>b-a).forEach(pts => {
    const group = byPoints[pts];
    group.sort((a,b) => a.will - b.will);
    const efficient = group.slice(0, 100);
    const inefficient = group.slice(-50).reverse();
    const combined = [...new Set([...efficient, ...inefficient])];
    finalResults.push(...combined);
  });

  return finalResults;
}

/* -------------------------
   Global optimizer with selectable cores
   ------------------------- */
function optimizeThreeCores(inv, coreConfigs){
  // determine which cores are enabled (0–2 indices)
  const enabledIndices = coreConfigs
    .map((cfg, idx) => (cfg.enabled === false ? null : idx))
    .filter(idx => idx !== null);

  const enabledCount = enabledIndices.length;
  if (enabledCount === 0) return { best: null, reason: 'no-cores-enabled' };

  const perCoreMaxWill = coreConfigs.map(c=> CORE_WILL[c.rarity]);
  const perCoreTarget  = coreConfigs.map(c=> c.target || 20);

  const caps = coreConfigs.map((cfg, idx) => {
    const baseTarget = perCoreTarget[idx] || 20;
    const maxCap = cfg.rarity === 'Legendary' ? 14 : 20;
    return Math.min(baseTarget, maxCap);
  });

  // build combos only for enabled cores
  const combosPerCore = enabledIndices.map(idx =>
    generateCoreCombos(inv, perCoreMaxWill[idx])
  );

  if (combosPerCore.some(list => list.length === 0)) {
    return { best: null, reason: 'no-combos' };
  }

  const trimmed = combosPerCore.map(list => list.slice(0, TOP_N));

  let best = null;

  function fitsInventory(trioCounts, inventory){
    for(const t of Object.keys(ASTROGEMS)){
      if((trioCounts[t]||0) > (inventory[t]||0)) return false;
    }
    return true;
  }

  // helper to compare candidate keys
  function isBetterKey(key, bestKey){
    for(let k=0;k<key.length;k++){
      if(key[k] < bestKey[k]) return true;
      if(key[k] > bestKey[k]) return false;
    }
    return false;
  }

  // 1 enabled core
  if (enabledCount === 1) {
    const gi0 = enabledIndices[0];
    const list0 = trimmed[0];

    for (let i0 = 0; i0 < list0.length; i0++) {
      const c0 = list0[i0];
      if (!fitsInventory(c0.counts || {}, inv)) continue;

      const pts0 = Math.min(c0.points, caps[gi0]);
      const totalPts = pts0;
      const pref = c0.prefScore || 0;
      const totalWill = c0.will || 0;

      const key = [-pts0, -totalPts, -pref, totalWill];
      const candidate = {
        combos: [c0],
        coreIndices: [gi0],
        counts: { ...(c0.counts || {}) },
        ptsRaw: [c0.points],
        will: [c0.will],
        key
      };

      if (!best || isBetterKey(key, best.key)) {
        best = candidate;
      }
    }
    return { best };
  }

  // 2 enabled cores
  if (enabledCount === 2) {
    const gi0 = enabledIndices[0];
    const gi1 = enabledIndices[1];
    const list0 = trimmed[0];
    const list1 = trimmed[1];

    for (let i0 = 0; i0 < list0.length; i0++) {
      const c0 = list0[i0];

      for (let i1 = 0; i1 < list1.length; i1++) {
        const c1 = list1[i1];

        const combined = {};
        for (const t of Object.keys(c0.counts || {})) combined[t] = (combined[t] || 0) + c0.counts[t];
        for (const t of Object.keys(c1.counts || {})) combined[t] = (combined[t] || 0) + c1.counts[t];

        if (!fitsInventory(combined, inv)) continue;

        const pts0 = Math.min(c0.points, caps[gi0]);
        const pts1 = Math.min(c1.points, caps[gi1]);
        const totalPts = pts0 + pts1;
        const pref = (c0.prefScore||0) + (c1.prefScore||0);
        const totalWill = (c0.will||0) + (c1.will||0);

        const key = [-pts0, -pts1, -totalPts, -pref, totalWill];
        const candidate = {
          combos: [c0, c1],
          coreIndices: [gi0, gi1],
          counts: combined,
          ptsRaw: [c0.points, c1.points],
          will: [c0.will, c1.will],
          key
        };

        if (!best || isBetterKey(key, best.key)) {
          best = candidate;
        }
      }
    }
    return { best };
  }

  // 3 enabled cores (full original behavior, but index-aware)
  if (enabledCount === 3) {
    const gi0 = enabledIndices[0];
    const gi1 = enabledIndices[1];
    const gi2 = enabledIndices[2];

    const list0 = trimmed[0];
    const list1 = trimmed[1];
    const list2 = trimmed[2];

    for(let i0=0;i0<list0.length;i0++){
      const c0 = list0[i0];
      for(let i1=0;i1<list1.length;i1++){
        const c1 = list1[i1];

        const partial = {};
        for(const t of Object.keys(c0.counts||{})) partial[t] = (partial[t]||0) + c0.counts[t];
        for(const t of Object.keys(c1.counts||{})) partial[t] = (partial[t]||0) + c1.counts[t];
        let ok01 = true;
        for(const t of Object.keys(partial)) if(partial[t] > (inv[t]||0)){ ok01=false; break; }
        if(!ok01) continue;

        for(let i2=0;i2<list2.length;i2++){
          const c2 = list2[i2];
          const combined = {...partial};
          for(const t of Object.keys(c2.counts||{})) combined[t] = (combined[t]||0) + c2.counts[t];
          if(!fitsInventory(combined, inv)) continue;

          const pts0 = Math.min(c0.points, caps[gi0]);
          const pts1 = Math.min(c1.points, caps[gi1]);
          const pts2 = Math.min(c2.points, caps[gi2]);
          const totalPts = pts0 + pts1 + pts2;
          const pref = (c0.prefScore||0) + (c1.prefScore||0) + (c2.prefScore||0);
          const totalWill = (c0.will||0) + (c1.will||0) + (c2.will||0);

          const key = [-pts0, -pts1, -pts2, -totalPts, -pref, totalWill];

          const candidate = {
            combos:[c0,c1,c2],
            coreIndices:[gi0,gi1,gi2],
            counts: combined,
            ptsRaw:[c0.points,c1.points,c2.points],
            will:[c0.will,c1.will,c2.will],
            key
          };

          if(!best || isBetterKey(key, best.key)) {
            best = candidate;
          }
        }
      }
    }
    return { best };
  }

  // should never hit here, but just in case
  return { best: null, reason: 'unexpected-state' };
}

/* -------------------------
   Config readers & render
   ------------------------- */
function readCoreConfigs(prefix){
  const arr=[];
  const isAuto = document.getElementById(prefix === 'class' ? 'classAuto' : 'generalAuto').checked;
  for(let i=1;i<=3;i++){
    const rarity  = document.getElementById(`${prefix}_core${i}_rarity`).value;
    const target  = isAuto ? 20 : parseInt(document.getElementById(`${prefix}_core${i}_target`).value);
    const enabledEl = document.getElementById(`${prefix}_core${i}_enabled`);
    const enabled = !enabledEl || enabledEl.checked;
    arr.push({ rarity, target, enabled });
  }
  return arr;
}

function buildGemCards(combo){
  return combo.map(t => {
    const c = t.toUpperCase();
    const info = ASTROGEMS[c];
    return `<div class="gem-card gem-${c}"><div class="gem-type">${c}</div><div class="gem-sub">${info.points}★ ${info.will}W</div></div>`;
  }).join('');
}

function computeRemaining(inv, used){
  const rem = {};
  for(const t of Object.keys(ASTROGEMS)) rem[t] = (inv[t]||0) - (used[t]||0);
  return rem;
}

function renderResults(containerId, resultObj, inv, coreConfigs){
  const container = document.getElementById(containerId);
  if(!resultObj || !resultObj.best){ 
    container.innerHTML = `<div class="small">No valid combos found (or inventory empty / cores disabled).</div>`; 
    return; 
  }
  const best = resultObj.best;
  let html = '';

  for(let i=0;i<best.combos.length;i++){
    const c = best.combos[i];
    const coreIdx = best.coreIndices ? best.coreIndices[i] : i; // fallback
    const gemCount = c.counts ? Object.values(c.counts).reduce((a,b)=>a+b,0) : c.combo.length;
    const cfg = coreConfigs[coreIdx] || {};
    const rarity = cfg.rarity || "Relic";
    html += `
      <div class="core-box" data-rarity="${rarity}">
        <div class="core-header" data-rarity="${rarity}">
          <div>
            <strong>${rarity} Core ${coreIdx+1}</strong>
            <span style="font-size:12px;color:#aaa">(${gemCount} gems)</span>
          </div>
          <div class="small" style="color:#fff">WP: ${c.will} &nbsp;•&nbsp; Pts: ${c.points}</div>
        </div>
        <div class="gem-row">${buildGemCards(c.combo)}</div>
      </div>
    `;
  }
  const remaining = computeRemaining(inv, best.counts || {});
  const badges = Object.keys(remaining).filter(k=>remaining[k]>0).map(k => `<div class="badge">${k}: ${remaining[k]}</div>`).join('');
  html += `<div style="padding:0 4px;margin-top:12px"><strong style="font-size:12px;color:#8a96a3;text-transform:uppercase;">Unused Gems</strong><div class="remaining-badges">${badges || '<span class="small">None</span>'}</div></div>`;
  container.innerHTML = html;
}

/* -------------------------
   Public calculate helpers
   ------------------------- */
function calculateClass(){
  const inv = readInventory('class');
  const cfg = readCoreConfigs('class');
  const res = optimizeThreeCores(inv, cfg);
  renderResults('classResultsInner', res, inv, cfg);
}

function calculateGeneral(){
  const inv = readInventory('general');
  const cfg = readCoreConfigs('general');
  const res = optimizeThreeCores(inv, cfg);
  renderResults('generalResultsInner', res, inv, cfg);
}

function calculateBoth(){
  calculateClass();
  calculateGeneral();
}

// auto-select numeric text when focused
document.addEventListener('focusin', function(e) {
  if (e.target.tagName === 'INPUT' && e.target.type === 'number') {
    setTimeout(() => e.target.select(), 0);
  }
});

window.onload = function(){
  buildCoreConfig('class_core_config','class');
  buildCoreConfig('general_core_config','general');
  refreshPresetDropdown();

  let autoLoaded = false;
  const last = localStorage.getItem(STORAGE_KEY_LAST);
  if (last) {
    const all = getAllInventories();
    if (all[last]) {
      const select = document.getElementById('inventorySelect');
      if (select) select.value = last;
      loadPresetByName(last, { silent: true });
      autoLoaded = true;
    }
  }

  if (!autoLoaded) {
    calculateBoth();
  }
};
</script>
</body>
</html>
